(function(f,i){var k={type:"",text:"",top:0,left:0,angle:45,size:50,distance:50,template:'<div class="grumble" style="display:none;filter:progid:DXImageTransform.Microsoft.Matrix(sizingMethod=\'auto expand\')">&#160;</div>',textTemplate:'<div class="grumble-text" style="display:none;"><div class="outer"><div class="inner">{text}</div></div></div>'};i.Bubble=function(b){this.options=f.extend({},k,b);this.context=document.body;this.css={};this.create()};i.Bubble.prototype={create:function(){var b=i.Bubble.prototype.tmpl;
this.bubble=f(b(this.options.template));this.text=f(b(this.options.textTemplate,{text:this.options.text}));this.setBubbleRotation();this.prepare()},setBubbleRotation:function(){this.rotateDeg=this.options.angle-45;this.rotateDeg<0&&(this.rotateDeg+=360)},prepare:function(){var b=this.bubble.get(0).parentNode;this.applyStyles();b!==this.context&&this.append();this.rotate()},applyStyles:function(){this.setPosition();this.css.width=this.options.size;this.css.height=this.options.size;this.text.css(this.css).addClass("grumble-text"+
this.options.size);this.bubble.css(this.css).addClass(this.options.type+"grumble"+this.options.size);this.realLeft=this.css.left;this.realTop=this.css.top},setPosition:function(){var b=this.options.angle/-360,e=this.options.size/2,d=this.options.size*this.options.size,d=Math.sqrt(d+d)/2,a=this.options.left-e-Math.sin(b*2*Math.PI)*(this.options.distance+d);this.css.top=this.options.top+e-Math.cos(b*2*Math.PI)*(this.options.distance+d)-this.options.size;this.css.left=a},append:function(){var b=this.context;
this.bubble.appendTo(b);this.text.appendTo(b)},rotate:function(){f.browser.msie===!0?this.ieRotate():this.cssRotate()},cssRotate:function(){this.bubble.css({"-moz-transform":"rotate("+this.rotateDeg+"deg)","-webkit-transform":"rotate("+this.rotateDeg+"deg)","-o-transform":"rotate("+this.rotateDeg+"deg)",transform:"rotate("+this.rotateDeg+"deg)"})},ieRotate:function(){var b=this.rotateDeg*(Math.PI*2/360),e=Math.cos(b),b=Math.sin(b),d=this.bubble.get(0);d.filters.item(0).M11=e;d.filters.item(0).M12=
-b;d.filters.item(0).M21=b;d.filters.item(0).M22=e;e=this.bubble.width();b=this.bubble.height();this.bubble.css({left:this.css.left-(e-this.options.size)/2,top:this.css.top-(b-this.options.size)/2})},adjust:function(b){f.extend(this.options,b);this.prepare()},tmpl:function(b,e,d){for(var a in e)e[a]===null&&(e[a]=""),typeof e[a]==="object"&&e[a].length&&(e[a]=e[a].join(", ")),b=b.replace(RegExp("{"+a+"}","g"),d?escape(e[a]):e[a]);return b}}})($,window);(function(f,i){function k(b,d,a){var i=f('<div style="position:absolute;visibilty:hidden;width:'+b+'px;">'+a+"</div>").appendTo(f(document.body)),j=i.outerHeight()*2+b*0.2,c=f.inArray(b,d);i.remove();return j>=b&&d[++c]?k(d[c],d,a):b}var b=[];f.fn.grumble=function(e){return typeof e==="string"?(this.trigger({type:e+".bubble"}),this):this.each(function(){var d=f(this),a=f.extend({},f.fn.grumble.defaults,e,d.data("bubble")||{}),l=d.offset(),j=k(a.size,a.sizeRange,a.text),c,g,h;a.top=l.top+d.height();
a.left=l.left+d.width()/2;h={init:function(){c=new i({text:a.text,top:a.top,left:a.left,angle:a.angle,size:j,distance:a.distance,type:a.type});a.hasHideButton&&this.addButton();b.push({grumble:c,button:g,onHide:function(){h.doOnBeginHideCallback();h.doOnHideCallback()}});a.showAfter&&this.createFxQueue();this.showBubble();a.hideAfter&&this.hideBubble();this.prepareEvents()},addButton:function(){var b=i.prototype.tmpl;g=f(b(a.buttonTemplate,{hideText:a.buttonHideText})).css({left:c.realLeft+j-10,top:c.realTop+
j-10}).insertAfter(c.text)},rePositionButton:function(){g&&g.css({left:c.realLeft+j-10,top:c.realTop+j-10})},createFxQueue:function(){c.bubble.queue("fx");c.text.queue("fx");c.bubble.delay(a.showAfter);c.text.delay(a.showAfter);g&&g.delay(a.showAfter)},showBubble:function(){f.browser.msie===!0?(c.bubble.queue("fx",function(a){c.bubble.show();a()}),c.text.queue("fx",function(a){c.text.show();a()}),g&&g.queue("fx",function(a){g.show();a()})):(c.bubble.fadeTo("fast",1),c.text.fadeTo("fast",1),g&&g.fadeTo("fast",
1));c.bubble.queue("fx",function(c){(a.hideOnClick||a.hasHideButton)&&h.hideOnClick();c()});c.bubble.queue("fx",function(a){h.doOnShowCallback();a()})},hideBubble:function(){c.bubble.delay(a.hideAfter);c.text.delay(a.hideAfter);c.bubble.queue("fx",function(a){h.doOnBeginHideCallback();a()});f.browser.msie===!0?(c.bubble.queue("fx",function(a){c.bubble.hide();a()}),c.bubble.queue("fx",function(a){c.text.hide();a()}),g&&g.queue("fx",function(a){g.hide();a()})):(c.bubble.fadeOut(),c.text.fadeOut(),g&&
g.fadeOut());c.bubble.queue("fx",function(a){h.doOnHideCallback();a()})},doOnBeginHideCallback:function(){a.onBeginHide(c,g)},doOnHideCallback:function(){a.onHide(c,g)},doOnShowCallback:function(){a.onShow(c,g)},hideOnClick:function(){f(document.body).bind("click.bubble",function(){h.hideBubble(c,g)})},prepareEvents:function(){f(window).bind("resize.bubble",function(){var a=d.offset(),b=a.top+d.height(),a=a.left+d.width()/2;c.adjust({top:b,left:a});h.rePositionButton()});d.bind("hide.bubble",function(){h.hideBubble(c,
g);f(this).unbind("hide.bubble")})}};h.init()})};f.fn.grumble.defaults={text:"",angle:45,size:50,sizeRange:[50,100,150,200],distance:0,type:"",showAfter:0,hideAfter:!1,hideOnClick:!1,hasHideButton:!1,buttonTemplate:'<div class="grumble-button" style="display:none" title="{hideText}">x</div>',buttonHideText:"Hide",onHide:function(){},onShow:function(){},onBeginHide:function(){}};f(document).bind("keyup.bubble",function(e){e.keyCode===27&&f.each(b,function(b,a){a.grumble.bubble.clearQueue().hide();
a.grumble.text.clearQueue().hide();a.button&&a.button.clearQueue().hide();a.onHide()})})})(jQuery,Bubble);
